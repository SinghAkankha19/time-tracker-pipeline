trigger: none

pool:
  name: 'Default'

variables:
  organization: 'adiraazad180822'
  project: 'ADO'
  branch: 'refs/heads/main'

steps:
- task: PowerShell@2
  displayName: 'Get pipeline runs between 7AM and 8AM'
  inputs:
    pwsh: true
    targetType: 'inline'  # This is required!
    script: |
      $ErrorActionPreference = 'Stop'

      # Define time window in UTC (adjust as needed)
      $now = Get-Date
      $today = $now.Date
      $startTime = $today.AddHours(7).ToUniversalTime().ToString("o")
      $endTime = $today.AddHours(8).ToUniversalTime().ToString("o")

      Write-Host "Fetching pipeline runs between $startTime and $endTime (UTC)"

      $organization = "$(organization)"
      $project = "$(project)"
      $branch = "$(branch)"
      $token = "$(System.AccessToken)"

      $url = "https://dev.azure.com/$organization/$project/_apis/build/builds?minTime=$startTime&maxTime=$endTime&branchName=$branch&api-version=7.1-preview.7"

      Write-Host "Calling Azure DevOps REST API:"
      Write-Host $url

      $headers = @{
        Authorization = "Bearer $token"
      }

      try {
        $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get

        if ($response.count -eq 0) {
          Write-Host "❌ No pipeline runs found in this time window."
        } else {
          Write-Host "✅ Pipelines run between 7AM-8AM:"
          $response.value | ForEach-Object {
            $pipelineName = $_.definition.name
            $runTime = $_.startTime
            Write-Host "- $pipelineName at $runTime"
          }
        }
      } catch {
        Write-Host "❌ Failed to call Azure DevOps API: $_"
      }
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
