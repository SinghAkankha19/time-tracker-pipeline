trigger: none

pool:
  name: 'Default'
  
schedules:
- cron: "35 2 * * 4"  # Every Thursday at 2:35 AM UTC (8:05 AM IST)
  displayName: Weekly Thursday 8:05 AM IST
  branches:
    include:
    - main
  always: true

variables:
  organization: 'adiraazad180822'
  project: 'ADO'
  branch: 'refs/heads/main'

steps:
# Step 1: Get pipeline runs between 7 AM and 8 AM IST
- task: PowerShell@2
  displayName: 'Get pipeline runs between 7AM and 8AM IST'
  inputs:
    pwsh: true
    targetType: 'inline'
    script: |
      $ErrorActionPreference = 'Stop'

      # Set time window in IST and convert to UTC
      $now = Get-Date
      $today = $now.Date
      $startTimeLocal = $today.AddHours(7)   # 7 AM IST
      $endTimeLocal = $today.AddHours(8)     # 8 AM IST

      $startTimeUtc = $startTimeLocal.AddHours(-5.5)
      $endTimeUtc = $endTimeLocal.AddHours(-5.5)

      $startTime = $startTimeUtc.ToString("o")
      $endTime = $endTimeUtc.ToString("o")

      Write-Host "Querying pipeline runs between $startTimeLocal and $endTimeLocal IST"
      Write-Host "Converted to UTC: $startTime to $endTime"

      $organization = "$(organization)"
      $project = "$(project)"
      $branch = "$(branch)"
      $token = "$(System.AccessToken)"

      $url = "https://dev.azure.com/$organization/$project/_apis/build/builds?minTime=$startTime&maxTime=$endTime&branchName=$branch&api-version=7.1-preview.7"

      $headers = @{
        Authorization = "Bearer $token"
      }

      $reportDate = Get-Date -Format "yyyy-MM-dd"
      $reportFolder = "$(Build.ArtifactStagingDirectory)\reports\$reportDate"
      New-Item -ItemType Directory -Force -Path $reportFolder | Out-Null

      $outputFile = "$reportFolder\pipeline_runs.md"
      $lines = @()

      try {
        $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get

        if ($response.count -eq 0) {
          Write-Host "No pipeline runs found in this time window."
          $lines += "No pipeline runs found between $startTimeLocal and $endTimeLocal (IST)"
        } else {
          Write-Host "Filtering pipeline runs between 7AM–8AM IST..."
          $lines += "### Pipeline runs between 7AM and 8AM IST ($reportDate):"

          $response.value | ForEach-Object {
            $pipelineName = $_.definition.name
            $runTimeUtc = [datetime]$_.startTime
            $runTimeIST = $runTimeUtc.AddHours(5.5)

            # Filter strictly between 7:00:00 and 7:59:59 IST
            if ($runTimeIST -ge $startTimeLocal -and $runTimeIST -lt $endTimeLocal) {
              Write-Host "- $pipelineName at $runTimeIST (IST)"
              $lines += "- $pipelineName at $runTimeIST (IST)"
            }
          }

          if ($lines.Count -eq 1) {
            $lines += "No qualifying pipeline runs found in the exact 7AM–8AM IST window."
          }
        }

        # Save report to file
        $lines | Out-File -FilePath $outputFile -Encoding utf8

      } catch {
        Write-Host "Failed to call Azure DevOps API: $_"
        "Error: $_" | Out-File -FilePath $outputFile -Encoding utf8
      }

  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)

# Step 2: Publish the report as a downloadable artifact
- task: PublishBuildArtifacts@1
  displayName: 'Publish pipeline report'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'pipeline-report'
# Step 1: Set report date as a pipeline variable
- task: PowerShell@2
  displayName: 'Set report date variable'
  inputs:
    pwsh: true
    targetType: 'inline'
    script: |
      $reportDate = Get-Date -Format "yyyy-MM-dd"
      Write-Host "Setting report date to $reportDate"
      Write-Host "##vso[task.setvariable variable=ReportDate]$reportDate"

# Step 2: Copy the markdown to a known path for publishing
- task: PowerShell@2
  displayName: 'Copy markdown file for artifact publishing'
  inputs:
    pwsh: true
    targetType: 'inline'
    script: |
      $src = "$(Build.ArtifactStagingDirectory)\reports\$(ReportDate)\pipeline_runs.md"
      $dest = "$(Build.ArtifactStagingDirectory)\pipeline_runs.md"

      if (Test-Path $src) {
        Copy-Item $src $dest -Force
        Write-Host "Copied report to artifact root."
      } else {
        Write-Host "Markdown file not found at: $src"
        exit 1
      }

# Step 3: Publish the markdown file as a pipeline artifact
- task: PublishPipelineArtifact@1
  displayName: 'Publish pipeline_runs.md as artifact'
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)\pipeline_runs.md'
    artifact: 'pipeline-report-markdown'

